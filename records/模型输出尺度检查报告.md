# UTNet模型输出尺度检查报告

## 检查日期
2024-12-07

## 检查目的
验证UTNet模型输出的2D keypoints和3D joints的尺度是否与Ground Truth (GT)一致，以排除尺度不匹配导致的loss不下降问题。

## 检查结果

### 1. 2D Keypoints格式 ✓ 一致

**模型输出** (`src/models/utnet.py:364-415`):
- 投影到像素坐标
- 归一化公式: `keypoints_2d = keypoints_2d_pixel / img_size - 0.5`
- 范围: **[-0.5, 0.5]**

**GT格式** (`dataloader/ho3d_dataset.py:895`):
- 归一化公式: `joint_img[:, 0:2] = joint_img[:, 0:2] / img_size - 0.5`
- 范围: **[-0.5, 0.5]**

**结论**: ✓ 格式完全一致

### 2. 3D Joints单位 ✓ 一致

**模型输出** (`src/models/utnet.py:221-222, 313-314`):
- MANO模型输出: **米 (meters)**
- 转换: `joints = mano_output['joints'] * 1000.0`
- 最终单位: **毫米 (millimeters)**

**GT格式** (`dataloader/ho3d_dataset.py:797, 920`):
- 原始数据: `joints_coord_cam` 从pickle文件加载，单位为**米**
- 转换: `joint_xyz = joints_coord_cam * 1000  # Convert to mm`
- 最终单位: **毫米 (millimeters)**

**结论**: ✓ 单位完全一致

### 3. 图像尺寸 ✓ 正确

- `img_size = [256, 192]` (H, W)
- 归一化公式:
  - x: `keypoints_2d[:, 0] = keypoints_2d_pixel[:, 0] / 192 - 0.5`
  - y: `keypoints_2d[:, 1] = keypoints_2d_pixel[:, 1] / 256 - 0.5`

**结论**: ✓ 尺寸和归一化公式正确

### 4. 投影函数逻辑 ✓ 正确

`_project_joints_to_2d` 函数 (`src/models/utnet.py:364-415`):
1. 输入: `joints (B, J, 3)` in **毫米**
2. 转换cam_params为camera translation (WiLoR公式)
3. 归一化focal_length (除以img_h)
4. 设置camera_center为图像中心
5. 转换joints从毫米到米: `joints / 1000.0`
6. 应用perspective_projection (得到像素坐标)
7. 归一化到**[-0.5, 0.5]**

**结论**: ✓ 逻辑正确，与WiLoR一致

### 5. 代码注释修正 ✓

**修正前** (`src/models/utnet.py:368`):
```python
"""
Normalized to [-1, 1] to match dataset format
"""
```

**修正后**:
```python
"""
Normalized to [-0.5, 0.5] to match dataset format
"""
```

**结论**: ✓ 注释已修正

## 总结

### ✓ 检查通过项
1. **2D keypoints格式**: 一致 (都是[-0.5, 0.5])
2. **3D joints单位**: 一致 (都是毫米)
3. **投影逻辑**: 正确
4. **代码注释**: 已修正

### 结论

**模型输出尺度与GT完全一致，不是loss不下降的原因。**

## 建议

由于模型输出尺度正确，loss不下降的原因可能在于：

1. **Loss权重过小** (最可能)
   - 当前: `w_2d=0.01`, `w_3d_joint=0.05`
   - 建议: `w_2d=1.0`, `w_3d_joint=1.0`
   - 原因: 权重过小导致有效梯度信号太弱

2. **缺少梯度裁剪**
   - 建议: 添加 `torch.nn.utils.clip_grad_norm_(model.parameters(), max_norm=1.0)`
   - 原因: 防止梯度爆炸或消失

3. **缺少详细的loss监控**
   - 建议: 打印各个loss组件的值（2D loss, 3D joint loss, prior loss, aux loss）
   - 原因: 便于诊断哪个loss占主导

4. **学习率可能不合适**
   - 当前: `1.0e-5`
   - 建议: 检查梯度大小，可能需要调整学习率

## 相关文件

- 检查脚本: `check_output_scale.py`
- 模型代码: `src/models/utnet.py`
- 数据加载器: `dataloader/ho3d_dataset.py`
- 配置文件: `config/config.yaml`






