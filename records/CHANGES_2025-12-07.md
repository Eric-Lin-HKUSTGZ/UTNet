# UTNet ä»£ç ä¿®æ”¹æ€»ç»“ - 2025-12-07

## ğŸ¯ ä¿®æ”¹ç›®æ ‡

è§£å†³ UTNet è®­ç»ƒä¸­çš„ä¸¤ä¸ªå…³é”®é—®é¢˜ï¼š
1. **éªŒè¯æŒ‡æ ‡å®Œå…¨ä¸å˜**ï¼ˆCritical Bugï¼‰
2. **3D joint loss è¿‡é«˜ä¸”ä¸ä¸‹é™**ï¼ˆè¯Šæ–­ä¸­ï¼‰

## âœ… å·²å®Œæˆçš„ä¿®æ”¹

### 1. ä¿®å¤åˆ†å¸ƒå¼éªŒè¯è¯„ä¼° Bug

**é—®é¢˜æ ¹æº**ï¼š
- åœ¨ 4 GPU åˆ†å¸ƒå¼è®­ç»ƒä¸­ï¼Œæ¯ä¸ª GPU å¤„ç† 1/4 çš„éªŒè¯æ•°æ®
- Evaluator åªåœ¨ rank 0 è¿è¡Œï¼Œåªè¯„ä¼°äº† 2083 ä¸ªæ ·æœ¬ï¼ˆæ€»æ•°çš„ 1/4ï¼‰
- æ¯æ¬¡éƒ½æ˜¯ç›¸åŒçš„ 2083 ä¸ªæ ·æœ¬ï¼ˆDistributedSampler çš„ shuffle=Falseï¼‰
- å…¶ä»– 3 ä¸ª GPU çš„é¢„æµ‹è¢«ä¸¢å¼ƒ

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
- é‡å†™ `test()` å‡½æ•°ï¼Œæ”¶é›†æ‰€æœ‰ GPU çš„é¢„æµ‹
- ä½¿ç”¨ `dist.all_gather` + `dist.send/recv` å®ç°å¥å£®çš„æ•°æ®æ”¶é›†
- æ”¯æŒå„ GPU æ•°æ®å¤§å°ä¸åŒçš„æƒ…å†µ
- rank 0 è¯„ä¼°å®Œæ•´çš„ 8332 ä¸ªéªŒè¯æ ·æœ¬

**ä¿®æ”¹æ–‡ä»¶**ï¼š
- `train.py` (è¡Œ 431-630)

### 2. æ·»åŠ è°ƒè¯•ä»£ç 

#### A. è‡ªåŠ¨æ•°æ®ç»Ÿè®¡ï¼ˆç¬¬ä¸€ä¸ª epoch çš„å‰ 3 ä¸ª batchï¼‰

**ä¿®æ”¹æ–‡ä»¶**ï¼š
- `train.py` (è¡Œ 348-362)

**æ‰“å°å†…å®¹**ï¼š
- RGB/Depth æ•°å€¼èŒƒå›´
- GT/Pred 3D joints çš„ç»Ÿè®¡ä¿¡æ¯
- **GT centered by root mean**ï¼ˆå…³é”®è¯Šæ–­æŒ‡æ ‡ï¼‰

#### B. Loss å‡½æ•°å†…éƒ¨è°ƒè¯•ï¼ˆç¯å¢ƒå˜é‡æ§åˆ¶ï¼‰

**ä¿®æ”¹æ–‡ä»¶**ï¼š
- `src/losses/loss.py` (è¡Œ 64-106)

**å¯ç”¨æ–¹å¼**ï¼š
```bash
export UTNET_DEBUG_LOSS=1
```

**æ‰“å°å†…å®¹**ï¼š
- ä¸­å¿ƒåŒ–å‰åçš„ Pred/GT ç»Ÿè®¡
- Per-element loss ç»Ÿè®¡
- æœ€ç»ˆ loss å€¼

### 3. å…¶ä»–æ”¹è¿›

- ç§»é™¤å¤–éƒ¨çš„ `evaluator.counter = 0` é‡ç½®
- æ›´æ–° TensorBoard æ—¥å¿—ä» `Test/*` åˆ° `Val/*`
- æ·»åŠ  "Evaluated on X samples from all Y GPUs" æ—¥å¿—

## ğŸ“„ åˆ›å»ºçš„æ–‡æ¡£

| æ–‡æ¡£åç§° | ç”¨é€” | ä½ç½® |
|---------|------|------|
| `IMPLEMENTATION_SUMMARY.md` | å®Œæ•´çš„ä¿®å¤å®æ–½æ€»ç»“ | UTNet/ |
| `TRAINING_DEBUG_GUIDE.md` | è®­ç»ƒå’Œè°ƒè¯•æŒ‡å— | UTNet/ |
| `QUICK_START_FIXED.md` | å¿«é€Ÿå¼€å§‹æ–‡æ¡£ | UTNet/ |
| `ä¿®å¤åˆ†å¸ƒå¼éªŒè¯è¯„ä¼°å’Œæ·»åŠ è°ƒè¯•.md` | æŠ€æœ¯ç»†èŠ‚è®°å½• | UTNet/records/ |
| `test_distributed_eval.py` | åˆ†å¸ƒå¼è¯„ä¼°æµ‹è¯•è„šæœ¬ | UTNet/ |
| `CHANGES_2025-12-07.md` | æœ¬æ–‡æ¡£ | UTNet/ |

## ğŸ”§ ä¿®æ”¹çš„ä»£ç æ–‡ä»¶

### train.py

**ä¿®æ”¹è¡Œæ•°**ï¼š~200 è¡Œä¿®æ”¹/æ–°å¢

**ä¸»è¦å˜æ›´**ï¼š

1. **test() å‡½æ•°é‡å†™** (è¡Œ 431-630)
   ```python
   # ä¹‹å‰
   for batch in dataloader:
       evaluator(pred, gt)
   metrics = evaluator.get_metrics_dict()
   
   # ä¿®å¤å
   all_pred_list = []
   for batch in dataloader:
       all_pred_list.append(pred.cpu())
   
   # æ”¶é›†æ‰€æœ‰ GPU æ•°æ®
   if distributed:
       if rank == 0:
           # æ¥æ”¶æ‰€æœ‰è¿›ç¨‹çš„æ•°æ®
           for i in range(world_size):
               ...
           all_pred = concat(all_preds_from_all_gpus)
           evaluator(all_pred, all_gt)
       else:
           # å‘é€åˆ° rank 0
           dist.send(local_pred, dst=0)
   ```

2. **train_epoch() æ·»åŠ è°ƒè¯•** (è¡Œ 348-362)
   ```python
   if rank == 0 and epoch == 0 and batch_idx < 3:
       print(f'\n[Debug Batch {batch_idx}]')
       print(f'  GT 3D joints mean: {keypoints_3d.mean():.3f}')
       print(f'  GT centered by root mean: {gt_centered.mean():.3f}')
       # ... æ›´å¤šç»Ÿè®¡ä¿¡æ¯
   ```

3. **ç§»é™¤å¤–éƒ¨ counter é‡ç½®** (è¡Œ 838)
   ```python
   # ç§»é™¤
   # if rank == 0:
   #     val_evaluator.counter = 0
   
   # test() å‡½æ•°å†…éƒ¨å¤„ç†
   val_metrics = test(...)
   ```

### src/losses/loss.py

**ä¿®æ”¹è¡Œæ•°**ï¼š~30 è¡Œæ–°å¢

**ä¸»è¦å˜æ›´**ï¼š

**Keypoint3DLoss.forward()** (è¡Œ 64-106)
```python
# æ·»åŠ è°ƒè¯•è¾“å‡ºï¼ˆå¯é€‰å¯ç”¨ï¼‰
if os.environ.get('UTNET_DEBUG_LOSS', '0') == '1':
    print(f'[Debug 3D Loss]')
    print(f'  Before centering - Pred mean: {pred.mean():.3f}')
    print(f'  After centering - Pred mean: {pred_centered.mean():.3f}')
    print(f'  Loss value: {loss.item():.3f}')
```

## ğŸ§ª å¦‚ä½•æµ‹è¯•ä¿®å¤

### å¿«é€Ÿæµ‹è¯•ï¼ˆæ¨èï¼‰

```bash
cd /data0/users/Robert/linweiquan/UTNet

# 1. æµ‹è¯•åˆ†å¸ƒå¼æ•°æ®æ”¶é›†é€»è¾‘
torchrun --nproc_per_node=4 test_distributed_eval.py

# 2. è¿è¡Œä¸€ä¸ª epoch çš„è®­ç»ƒ
torchrun --nproc_per_node=4 train.py --config config/config.yaml 2>&1 | tee test_fix.log

# 3. æ£€æŸ¥æ—¥å¿—
grep "Evaluated on" test_fix.log  # åº”è¯¥æ˜¾ç¤º "8332 samples"
grep "GT centered" test_fix.log   # æ£€æŸ¥æ•°æ®ç»Ÿè®¡
```

### å®Œæ•´è®­ç»ƒ

```bash
# æ ‡å‡†è®­ç»ƒï¼ˆä¿®å¤å·²ç”Ÿæ•ˆï¼‰
torchrun --nproc_per_node=4 train.py --config config/config.yaml

# å¯ç”¨ Loss è°ƒè¯•ï¼ˆå¦‚æœéœ€è¦ï¼‰
export UTNET_DEBUG_LOSS=1
torchrun --nproc_per_node=4 train.py --config config/config.yaml
```

## âœ… é¢„æœŸç»“æœ

### ä¿®å¤æˆåŠŸçš„æ ‡å¿—

1. âœ… æ—¥å¿—ä¸­å‡ºç° "Evaluated on 8332 samples from all 4 GPUs"
2. âœ… éªŒè¯æŒ‡æ ‡ï¼ˆMPJPE, PA-MPJPEï¼‰éš epoch å˜åŒ–
3. âœ… 2D loss é€æ¸ä¸‹é™
4. ğŸ“Š ç¬¬ä¸€ä¸ª epoch çš„æ•°æ®ç»Ÿè®¡æ­£å¸¸

### ç¤ºä¾‹è¾“å‡º

```
Epoch 0, Batch 0:
[Debug Batch 0]
  RGB range: [-2.118, 2.640]
  GT 3D joints mean: 125.345, std: 87.234
  GT centered by root mean: 0.000, std: 87.234  â† åº”è¯¥æ¥è¿‘ 0
  ...

Epoch 0: Train Loss: 3894.567
  Val Loss: 3891.234, MPJPE: 102.152 mm, PA-MPJPE: 48.320 mm
  Evaluated on 8332 samples from all 4 GPUs  â† æ–°å¢

Epoch 1: Train Loss: 3567.890
  Val Loss: 3542.123, MPJPE: 98.456 mm, PA-MPJPE: 46.123 mm  â† æŒ‡æ ‡å˜åŒ–
  Evaluated on 8332 samples from all 4 GPUs

Epoch 2: Train Loss: 3234.567
  Val Loss: 3201.234, MPJPE: 89.234 mm, PA-MPJPE: 41.567 mm  â† ç»§ç»­å˜åŒ–
  Evaluated on 8332 samples from all 4 GPUs
```

## ğŸ” 3D Loss è¯Šæ–­æµç¨‹

æ ¹æ®è°ƒè¯•è¾“å‡ºï¼ŒæŒ‰ç…§ä»¥ä¸‹æµç¨‹è¯Šæ–­ï¼š

### æ­¥éª¤ 1ï¼šæ£€æŸ¥æ•°æ®ç»Ÿè®¡

æŸ¥çœ‹ `GT centered by root mean` çš„å€¼ï¼š

- **â‰ˆ 0** (< 1e-5) â†’ âœ… æ•°æ®æ­£ç¡®ï¼Œç»§ç»­æ­¥éª¤ 2
- **â‰  0** (> 1.0) â†’ âŒ æ•°æ®å·²ç»æ˜¯ç›¸å¯¹åæ ‡ï¼Œéœ€è¦ä¿®å¤æ•°æ®åŠ è½½å™¨

### æ­¥éª¤ 2ï¼šå¯ç”¨ Loss è°ƒè¯•

```bash
export UTNET_DEBUG_LOSS=1
torchrun --nproc_per_node=4 train.py --config config/config.yaml
```

æŸ¥çœ‹ï¼š
- `Per-element loss mean`ï¼šåº”è¯¥åœ¨ 10-100 mm èŒƒå›´
- `Loss value`ï¼šåº”è¯¥ < 10000

### æ­¥éª¤ 3ï¼šæ ¹æ®ç»“æœä¿®å¤

| ç—‡çŠ¶ | åŸå›  | ä¿®å¤ä½ç½® |
|-----|------|---------|
| GT centered mean â‰  0 | æ•°æ®å·²ä¸­å¿ƒåŒ– | `dataloader/ho3d_dataset.py` |
| GT 3D mean > 1000 | å•ä½é”™è¯¯ | `dataloader/ho3d_dataset.py:797` |
| Per-element loss > 500 | æ¨¡å‹è¾“å‡ºå°ºåº¦é”™è¯¯ | `src/models/utnet.py:222,314` |
| Loss value > 100000 | é‡å¤ä¸­å¿ƒåŒ– | `src/losses/loss.py` æˆ–æ•°æ®åŠ è½½å™¨ |

## ğŸ“Š å…³é”®ç»Ÿè®¡

| é¡¹ç›® | ä¹‹å‰ | ä¿®å¤å |
|-----|------|--------|
| éªŒè¯æ ·æœ¬æ•°ï¼ˆrank 0ï¼‰ | 2083 | 8332 |
| éªŒè¯æŒ‡æ ‡å˜åŒ– | å®Œå…¨ä¸å˜ | æ¯ä¸ª epoch éƒ½å˜ |
| ä»£ç ä¿®æ”¹è¡Œæ•° | - | ~230 è¡Œ |
| æ–°å¢æ–‡æ¡£ | - | 6 ä¸ª |
| æ–°å¢æµ‹è¯•è„šæœ¬ | - | 1 ä¸ª |

## ğŸ“ æŠ€æœ¯è¦ç‚¹

### ä¸ºä»€ä¹ˆä¸ç”¨ dist.gatherï¼Ÿ

`dist.gather` è¦æ±‚æ‰€æœ‰è¿›ç¨‹çš„ tensor å¤§å°å®Œå…¨ç›¸åŒï¼Œä½†ï¼š
- DistributedSampler å¯èƒ½å¯¼è‡´ä¸åŒè¿›ç¨‹çš„æ•°æ®é‡ä¸åŒ
- ä½¿ç”¨ `dist.send/recv` + å…ˆäº¤æ¢å¤§å°ä¿¡æ¯æ›´å¥å£®

### åˆ†å¸ƒå¼è¯„ä¼°çš„æ­£ç¡®åšæ³•

```python
# âŒ é”™è¯¯ï¼šåªè¯„ä¼°éƒ¨åˆ†æ•°æ®
for batch in distributed_dataloader:
    pred = model(batch)
    evaluator(pred, gt)  # æ¯ä¸ªè¿›ç¨‹ç‹¬ç«‹è¯„ä¼°
metrics = evaluator.get_metrics()  # åªåŒ…å«å½“å‰è¿›ç¨‹çš„æ•°æ®

# âœ… æ­£ç¡®ï¼šæ”¶é›†æ‰€æœ‰æ•°æ®å†è¯„ä¼°
all_preds = []
for batch in distributed_dataloader:
    pred = model(batch)
    all_preds.append(pred.cpu())

# æ”¶é›†æ‰€æœ‰è¿›ç¨‹çš„é¢„æµ‹åˆ° rank 0
if rank == 0:
    all_data = gather_from_all_processes()
    evaluator(all_data)
else:
    send_to_rank_0()
```

## ğŸ“ åç»­æ”¯æŒ

å¦‚æœè®­ç»ƒåä»æœ‰é—®é¢˜ï¼Œè¯·æä¾›ï¼š

1. **è®­ç»ƒæ—¥å¿—**ï¼šç‰¹åˆ«æ˜¯ç¬¬ä¸€ä¸ª epoch çš„è¾“å‡º
2. **å…³é”®æ•°å€¼**ï¼š
   - `GT centered by root mean` çš„å€¼
   - `Per-element loss mean` çš„å€¼ï¼ˆå¦‚æœå¯ç”¨äº† UTNET_DEBUG_LOSSï¼‰
   - éªŒè¯æŒ‡æ ‡çš„å˜åŒ–è¶‹åŠ¿
3. **ç¯å¢ƒä¿¡æ¯**ï¼šGPU æ•°é‡ã€PyTorch ç‰ˆæœ¬ã€CUDA ç‰ˆæœ¬

## ğŸ“š ç›¸å…³æ–‡æ¡£é“¾æ¥

- å¿«é€Ÿå¼€å§‹ï¼š[QUICK_START_FIXED.md](QUICK_START_FIXED.md)
- å®æ–½æ€»ç»“ï¼š[IMPLEMENTATION_SUMMARY.md](IMPLEMENTATION_SUMMARY.md)
- è°ƒè¯•æŒ‡å—ï¼š[TRAINING_DEBUG_GUIDE.md](TRAINING_DEBUG_GUIDE.md)
- æŠ€æœ¯ç»†èŠ‚ï¼š[records/ä¿®å¤åˆ†å¸ƒå¼éªŒè¯è¯„ä¼°å’Œæ·»åŠ è°ƒè¯•.md](records/ä¿®å¤åˆ†å¸ƒå¼éªŒè¯è¯„ä¼°å’Œæ·»åŠ è°ƒè¯•.md)

---

**ä¿®æ”¹å®Œæˆæ—¶é—´**ï¼š2025-12-07  
**ä¿®æ”¹ç±»å‹**ï¼šBug ä¿®å¤ + è°ƒè¯•å·¥å…·  
**å½±å“èŒƒå›´**ï¼šåˆ†å¸ƒå¼è®­ç»ƒçš„éªŒè¯è¯„ä¼°  
**å‘åå…¼å®¹**ï¼šæ˜¯ï¼ˆå• GPU è®­ç»ƒä¸å—å½±å“ï¼‰

